package librarysystem;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.ArrayList;

public class AdminDashboard extends JFrame {
    private Library library;
    private User user;
    private JTable booksTable;
    private DefaultTableModel booksTableModel;
    private JTable usersTable;
    private DefaultTableModel usersTableModel;
    private JTable reportsTable;
    private DefaultTableModel reportsTableModel;
    private JTable transactionsTable;
    private DefaultTableModel transactionsTableModel;

    public AdminDashboard(Library library, User user) {
        this.library = library;
        this.user = user;
        initComponents();
        refreshAllData();
    }

    private void initComponents() {
        setTitle("Library Management System - Admin Dashboard");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setSize(1300, 800);
        setLocationRelativeTo(null);

        JPanel mainPanel = new JPanel(new BorderLayout());

        JPanel headerPanel = new JPanel(new BorderLayout());
        JLabel titleLabel = new JLabel("ðŸ“š ADMIN DASHBOARD - Welcome " + user.getUsername());
        titleLabel.setFont(new Font("Arial", Font.BOLD, 18));
        titleLabel.setForeground(new Color(0, 100, 0));
        headerPanel.add(titleLabel, BorderLayout.CENTER);

        JPanel headerRightPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton updateReputationsButton = new JButton("ðŸ”„ Update Reputations");
        updateReputationsButton.setFont(new Font("Arial", Font.BOLD, 12));
        updateReputationsButton.addActionListener(e -> {
            library.updateAllReputations();
            JOptionPane.showMessageDialog(this, "Reputations updated successfully!");
            refreshUsers();
        });
        headerRightPanel.add(updateReputationsButton);

        JButton globalRefreshButton = new JButton("âŸ³ Refresh All");
        globalRefreshButton.setFont(new Font("Arial", Font.BOLD, 12));
        globalRefreshButton.addActionListener(e -> refreshAllData());
        headerRightPanel.add(globalRefreshButton);
        headerPanel.add(headerRightPanel, BorderLayout.EAST);

        mainPanel.add(headerPanel, BorderLayout.NORTH);

        JTabbedPane tabbedPane = new JTabbedPane();
        tabbedPane.addTab("ðŸ“– Manage Books", createBooksTab());
        tabbedPane.addTab("ðŸ‘¥ Manage Users", createUsersTab());
        tabbedPane.addTab("ðŸ“Š Reports", createReportsTab());
        tabbedPane.addTab("ðŸ“ Transactions", createTransactionsTab());
        tabbedPane.addTab("ðŸ‘¤ My Profile", createProfileTab());

        mainPanel.add(tabbedPane, BorderLayout.CENTER);

        JPanel footerPanel = new JPanel(new BorderLayout());
        JLabel statusLabel = new JLabel(" Ready");
        statusLabel.setFont(new Font("Arial", Font.PLAIN, 12));
        footerPanel.add(statusLabel, BorderLayout.WEST);

        JPanel logoutPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton logoutButton = new JButton("ðŸšª Logout");
        logoutButton.addActionListener(e -> logout());
        logoutPanel.add(logoutButton);
        footerPanel.add(logoutPanel, BorderLayout.EAST);

        mainPanel.add(footerPanel, BorderLayout.SOUTH);

        add(mainPanel);
    }

    private JPanel createBooksTab() {
        JPanel panel = new JPanel(new BorderLayout(10, 10));
        panel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        String[] columns = {"ID", "Title", "Author", "Quantity", "Status", "Borrowed By"};
        booksTableModel = new DefaultTableModel(columns, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return false;
            }
        };
        booksTable = new JTable(booksTableModel);
        booksTable.setRowHeight(25);
        JScrollPane scrollPane = new JScrollPane(booksTable);
        scrollPane.setBorder(BorderFactory.createTitledBorder("Books Collection"));

        panel.add(scrollPane, BorderLayout.CENTER);

        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 10, 10));
        JButton addButton = new JButton("âž• Add Book");
        JButton removeButton = new JButton("ðŸ—‘ï¸ Remove Book");
        JButton refreshButton = new JButton("âŸ³ Refresh Books");

        addButton.addActionListener(e -> addBook());
        removeButton.addActionListener(e -> removeBook());
        refreshButton.addActionListener(e -> refreshBooks());

        buttonPanel.add(addButton);
        buttonPanel.add(removeButton);
        buttonPanel.add(refreshButton);

        panel.add(buttonPanel, BorderLayout.SOUTH);

        return panel;
    }

    private JPanel createUsersTab() {
        JPanel panel = new JPanel(new BorderLayout(10, 10));
        panel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        // UPDATED: Added reputation column
        String[] columns = {"ID", "Username", "Role", "Reputation", "Status", "Locked"};
        usersTableModel = new DefaultTableModel(columns, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return false;
            }
        };
        usersTable = new JTable(usersTableModel);
        usersTable.setRowHeight(25);
        JScrollPane scrollPane = new JScrollPane(usersTable);
        scrollPane.setBorder(BorderFactory.createTitledBorder("System Users"));

        panel.add(scrollPane, BorderLayout.CENTER);

        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 10, 10));
        JButton lockButton = new JButton("ðŸ”’ Lock/Unlock");
        JButton adjustRepButton = new JButton("â­ Adjust Reputation");
        JButton deleteButton = new JButton("ðŸ—‘ï¸ Delete User");
        JButton viewProfileButton = new JButton("ðŸ‘ï¸ View Profile");
        JButton refreshButton = new JButton("âŸ³ Refresh Users");

        lockButton.addActionListener(e -> toggleUserLock());
        adjustRepButton.addActionListener(e -> adjustReputation());
        deleteButton.addActionListener(e -> deleteUser());
        viewProfileButton.addActionListener(e -> viewUserProfile());
        refreshButton.addActionListener(e -> refreshUsers());

        buttonPanel.add(lockButton);
        buttonPanel.add(adjustRepButton);
        buttonPanel.add(deleteButton);
        buttonPanel.add(viewProfileButton);
        buttonPanel.add(refreshButton);

        panel.add(buttonPanel, BorderLayout.SOUTH);

        return panel;
    }

    private JPanel createReportsTab() {
        JPanel panel = new JPanel(new BorderLayout(10, 10));
        panel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        // UPDATED: Added due date and reputation columns
        String[] columns = {"Title", "Author", "Borrowed By", "Borrow Date", "Due Date", "Reputation"};
        reportsTableModel = new DefaultTableModel(columns, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return false;
            }
        };
        reportsTable = new JTable(reportsTableModel);
        reportsTable.setRowHeight(25);
        JScrollPane scrollPane = new JScrollPane(reportsTable);
        scrollPane.setBorder(BorderFactory.createTitledBorder("Currently Borrowed Books"));

        panel.add(scrollPane, BorderLayout.CENTER);

        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton refreshButton = new JButton("âŸ³ Refresh Report");
        refreshButton.addActionListener(e -> refreshReports());

        buttonPanel.add(refreshButton);
        panel.add(buttonPanel, BorderLayout.SOUTH);

        return panel;
    }

    private JPanel createTransactionsTab() {
        JPanel panel = new JPanel(new BorderLayout(10, 10));
        panel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        String[] columns = {"Username", "Book Title", "Action", "Date/Time"};
        transactionsTableModel = new DefaultTableModel(columns, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return false;
            }
        };
        transactionsTable = new JTable(transactionsTableModel);
        transactionsTable.setRowHeight(25);
        JScrollPane scrollPane = new JScrollPane(transactionsTable);
        scrollPane.setBorder(BorderFactory.createTitledBorder("Transaction History"));

        panel.add(scrollPane, BorderLayout.CENTER);

        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton refreshButton = new JButton("âŸ³ Refresh Transactions");
        refreshButton.addActionListener(e -> refreshTransactions());

        buttonPanel.add(refreshButton);
        panel.add(buttonPanel, BorderLayout.SOUTH);

        return panel;
    }

    private JPanel createProfileTab() {
        JPanel panel = new JPanel(new BorderLayout(10, 10));
        panel.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));

        JPanel profilePanel = new JPanel(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(10, 10, 10, 10);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.anchor = GridBagConstraints.WEST;

        gbc.gridx = 0;
        gbc.gridy = 0;
        profilePanel.add(new JLabel("Username:"), gbc);

        gbc.gridx = 1;
        JTextField usernameField = new JTextField(user.getUsername(), 25);
        usernameField.setEditable(false);
        profilePanel.add(usernameField, gbc);

        gbc.gridx = 0;
        gbc.gridy = 1;
        profilePanel.add(new JLabel("Role:"), gbc);

        gbc.gridx = 1;
        JTextField roleField = new JTextField(user.getRole(), 25);
        roleField.setEditable(false);
        profilePanel.add(roleField, gbc);

        gbc.gridx = 0;
        gbc.gridy = 2;
        gbc.gridwidth = 2;
        profilePanel.add(new JSeparator(), gbc);

        gbc.gridy = 3;
        gbc.gridwidth = 2;
        JLabel passTitle = new JLabel("Change Password");
        passTitle.setFont(new Font("Arial", Font.BOLD, 14));
        profilePanel.add(passTitle, gbc);

        gbc.gridy = 4;
        gbc.gridwidth = 1;
        profilePanel.add(new JLabel("New Password:"), gbc);

        gbc.gridx = 1;
        JPasswordField newPassField = new JPasswordField(25);
        profilePanel.add(newPassField, gbc);

        gbc.gridx = 0;
        gbc.gridy = 5;
        profilePanel.add(new JLabel("Confirm Password:"), gbc);

        gbc.gridx = 1;
        JPasswordField confirmPassField = new JPasswordField(25);
        profilePanel.add(confirmPassField, gbc);

        gbc.gridx = 0;
        gbc.gridy = 6;
        gbc.gridwidth = 2;
        JButton changePassButton = new JButton("ðŸ” Change My Password");
        changePassButton.addActionListener(e -> changePassword(newPassField, confirmPassField));
        profilePanel.add(changePassButton, gbc);

        gbc.gridy = 7;
        gbc.weighty = 1.0;
        gbc.fill = GridBagConstraints.BOTH;
        profilePanel.add(new JPanel(), gbc);

        panel.add(profilePanel, BorderLayout.CENTER);

        JPanel refreshPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton refreshProfileButton = new JButton("âŸ³ Refresh Profile");
        refreshProfileButton.addActionListener(e -> refreshProfile());
        refreshPanel.add(refreshProfileButton);
        panel.add(refreshPanel, BorderLayout.SOUTH);

        return panel;
    }

    private void refreshAllData() {
        library.updateAllReputations(); // NEW: Update reputations first
        refreshBooks();
        refreshUsers();
        refreshReports();
        refreshTransactions();
        JOptionPane.showMessageDialog(this,
                "All data refreshed successfully! Reputations updated.",
                "Refresh Complete", JOptionPane.INFORMATION_MESSAGE);
    }

    private void refreshBooks() {
        try {
            library.refreshConnection();
            ArrayList<Book> books = library.getAllBooks();

            SwingUtilities.invokeLater(() -> {
                booksTableModel.setRowCount(0);
                for (Book book : books) {
                    String status = book.isBorrowed() ? "Borrowed" : "Available";
                    booksTableModel.addRow(new Object[]{
                            book.getId(),
                            book.getTitle(),
                            book.getAuthor(),
                            book.getQuantity(),
                            status,
                            book.getBorrowedBy() != null ? book.getBorrowedBy() : ""
                    });
                }
            });
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this,
                    "Error refreshing books: " + e.getMessage(),
                    "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void refreshUsers() {
        try {
            library.refreshConnection();
            ArrayList<User> users = library.getAllUsers();

            SwingUtilities.invokeLater(() -> {
                usersTableModel.setRowCount(0);
                for (User user : users) {
                    String status = user.isLocked() ? "LOCKED" : "ACTIVE";
                    String reputationText = user.getReputation() + "/100";

                    // Color code reputation
                    if (user.getRole().equals("student")) {
                        if (user.getReputation() >= 80) reputationText += " (Excellent)";
                        else if (user.getReputation() >= 60) reputationText += " (Good)";
                        else if (user.getReputation() >= 40) reputationText += " (Fair)";
                        else reputationText += " (Poor)";
                    }

                    usersTableModel.addRow(new Object[]{
                            user.getId(),
                            user.getUsername(),
                            user.getRole(),
                            reputationText,
                            status,
                            user.isLocked()
                    });
                }
            });
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this,
                    "Error refreshing users: " + e.getMessage(),
                    "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void refreshReports() {
        try {
            library.refreshConnection();
            ArrayList<Object[]> reportData = library.getBorrowedBooksReport();

            SwingUtilities.invokeLater(() -> {
                reportsTableModel.setRowCount(0);
                for (Object[] row : reportData) {
                    String reputationText = row[5] + "/100";
                    int reputation = (int) row[5];
                    if (reputation >= 80) reputationText += " (Excellent)";
                    else if (reputation >= 60) reputationText += " (Good)";
                    else if (reputation >= 40) reputationText += " (Fair)";
                    else reputationText += " (Poor)";

                    reportsTableModel.addRow(new Object[]{
                            row[0], // title
                            row[1], // author
                            row[2], // username
                            row[3], // borrow date
                            row[4], // due date
                            reputationText
                    });
                }

                if (reportsTableModel.getRowCount() == 0) {
                    reportsTableModel.addRow(new Object[]{
                            "No books currently borrowed", "", "", "", "", ""
                    });
                }
            });
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this,
                    "Error refreshing reports: " + e.getMessage(),
                    "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void refreshTransactions() {
        try {
            library.refreshConnection();
            ArrayList<Object[]> transData = library.getTransactionHistory();

            SwingUtilities.invokeLater(() -> {
                transactionsTableModel.setRowCount(0);
                for (Object[] row : transData) {
                    transactionsTableModel.addRow(row);
                }

                if (transactionsTableModel.getRowCount() == 0) {
                    transactionsTableModel.addRow(new Object[]{
                            "No transactions found", "", "", ""
                    });
                }
            });
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this,
                    "Error refreshing transactions: " + e.getMessage(),
                    "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void refreshProfile() {
        try {
            library.refreshConnection();
            User updatedUser = library.getUserProfile(user.getId());
            if (updatedUser != null) {
                user = updatedUser;
                JOptionPane.showMessageDialog(this,
                        "Profile refreshed!",
                        "Success", JOptionPane.INFORMATION_MESSAGE);
            }
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this,
                    "Error refreshing profile: " + e.getMessage(),
                    "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void addBook() {
        JTextField titleField = new JTextField();
        JTextField authorField = new JTextField();
        JTextField quantityField = new JTextField("1");

        JPanel panel = new JPanel(new GridLayout(0, 2, 10, 10));
        panel.add(new JLabel("Title:"));
        panel.add(titleField);
        panel.add(new JLabel("Author:"));
        panel.add(authorField);
        panel.add(new JLabel("Quantity:"));
        panel.add(quantityField);

        int result = JOptionPane.showConfirmDialog(this, panel, "Add New Book",
                JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);

        if (result == JOptionPane.OK_OPTION) {
            String title = titleField.getText().trim();
            String author = authorField.getText().trim();
            int quantity;

            try {
                quantity = Integer.parseInt(quantityField.getText().trim());
            } catch (NumberFormatException e) {
                quantity = 1;
            }

            if (title.isEmpty() || author.isEmpty()) {
                JOptionPane.showMessageDialog(this, "Please fill all fields",
                        "Error", JOptionPane.ERROR_MESSAGE);
                return;
            }

            boolean success = library.addBook(title, author, quantity);
            if (success) {
                JOptionPane.showMessageDialog(this, "Book added successfully!",
                        "Success", JOptionPane.INFORMATION_MESSAGE);
                refreshBooks();
            } else {
                JOptionPane.showMessageDialog(this, "Failed to add book",
                        "Error", JOptionPane.ERROR_MESSAGE);
            }
        }
    }

    private void removeBook() {
        int selectedRow = booksTable.getSelectedRow();
        if (selectedRow == -1) {
            JOptionPane.showMessageDialog(this, "Please select a book to remove",
                    "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        int bookId = (int) booksTableModel.getValueAt(selectedRow, 0);
        String bookTitle = (String) booksTableModel.getValueAt(selectedRow, 1);

        int confirm = JOptionPane.showConfirmDialog(this,
                "Are you sure you want to remove '" + bookTitle + "'?",
                "Confirm Removal", JOptionPane.YES_NO_OPTION);

        if (confirm == JOptionPane.YES_OPTION) {
            boolean success = library.removeBook(bookId);
            if (success) {
                JOptionPane.showMessageDialog(this, "Book removed successfully!",
                        "Success", JOptionPane.INFORMATION_MESSAGE);
                refreshBooks();
            } else {
                JOptionPane.showMessageDialog(this, "Failed to remove book",
                        "Error", JOptionPane.ERROR_MESSAGE);
            }
        }
    }

    private void toggleUserLock() {
        int selectedRow = usersTable.getSelectedRow();
        if (selectedRow == -1) {
            JOptionPane.showMessageDialog(this, "Please select a user",
                    "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        int userId = (int) usersTableModel.getValueAt(selectedRow, 0);
        String username = (String) usersTableModel.getValueAt(selectedRow, 1);
        boolean isLocked = (boolean) usersTableModel.getValueAt(selectedRow, 5);
        boolean isAdmin = "admin".equals(usersTableModel.getValueAt(selectedRow, 2));

        if (isAdmin) {
            JOptionPane.showMessageDialog(this, "Cannot lock/unlock admin accounts",
                    "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        String action = isLocked ? "unlock" : "lock";
        int confirm = JOptionPane.showConfirmDialog(this,
                "Are you sure you want to " + action + " user '" + username + "'?",
                "Confirm " + action, JOptionPane.YES_NO_OPTION);

        if (confirm == JOptionPane.YES_OPTION) {
            try {
                library.refreshConnection();
                boolean success = library.toggleUserLock(userId, !isLocked);
                if (success) {
                    JOptionPane.showMessageDialog(this,
                            "User " + action + "ed successfully!", "Success",
                            JOptionPane.INFORMATION_MESSAGE);
                    refreshUsers();
                } else {
                    JOptionPane.showMessageDialog(this, "Failed to " + action + " user",
                            "Error", JOptionPane.ERROR_MESSAGE);
                }
            } catch (Exception e) {
                JOptionPane.showMessageDialog(this,
                        "Error: " + e.getMessage(),
                        "Database Error", JOptionPane.ERROR_MESSAGE);
            }
        }
    }

    // NEW: Adjust reputation method
    private void adjustReputation() {
        int selectedRow = usersTable.getSelectedRow();
        if (selectedRow == -1) {
            JOptionPane.showMessageDialog(this, "Please select a user",
                    "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        int userId = (int) usersTableModel.getValueAt(selectedRow, 0);
        String username = (String) usersTableModel.getValueAt(selectedRow, 1);
        String role = (String) usersTableModel.getValueAt(selectedRow, 2);

        if (!"student".equals(role)) {
            JOptionPane.showMessageDialog(this, "Can only adjust reputation for students",
                    "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        // Get current reputation
        User selectedUser = library.getUserProfile(userId);
        if (selectedUser == null) return;

        // Create adjustment dialog
        JPanel panel = new JPanel(new GridLayout(3, 2, 10, 10));
        JLabel currentLabel = new JLabel("Current Reputation:");
        JLabel currentValue = new JLabel(selectedUser.getReputation() + "/100");
        currentValue.setFont(new Font("Arial", Font.BOLD, 12));

        JLabel adjustmentLabel = new JLabel("Adjustment (+/-):");
        JTextField adjustmentField = new JTextField("0");

        JLabel reasonLabel = new JLabel("Reason:");
        JTextField reasonField = new JTextField();

        panel.add(currentLabel);
        panel.add(currentValue);
        panel.add(adjustmentLabel);
        panel.add(adjustmentField);
        panel.add(reasonLabel);
        panel.add(reasonField);

        int result = JOptionPane.showConfirmDialog(this, panel,
                "Adjust Reputation for " + username,
                JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);

        if (result == JOptionPane.OK_OPTION) {
            try {
                int adjustment = Integer.parseInt(adjustmentField.getText().trim());
                String reason = reasonField.getText().trim();

                if (adjustment == 0) {
                    JOptionPane.showMessageDialog(this, "No adjustment made",
                            "Info", JOptionPane.INFORMATION_MESSAGE);
                    return;
                }

                if (Math.abs(adjustment) > 100) {
                    JOptionPane.showMessageDialog(this, "Adjustment must be between -100 and +100",
                            "Error", JOptionPane.ERROR_MESSAGE);
                    return;
                }

                if (adjustment < 0 && reason.isEmpty()) {
                    JOptionPane.showMessageDialog(this, "Please provide a reason for reputation decrease",
                            "Error", JOptionPane.ERROR_MESSAGE);
                    return;
                }

                library.refreshConnection();
                boolean success = library.adjustReputation(userId, adjustment);
                if (success) {
                    int newReputation = Math.max(0, Math.min(100, selectedUser.getReputation() + adjustment));
                    String message = "Reputation adjusted by " + (adjustment > 0 ? "+" : "") + adjustment + " points\n" +
                            "New reputation: " + newReputation + "/100";
                    if (!reason.isEmpty()) {
                        message += "\nReason: " + reason;
                    }

                    JOptionPane.showMessageDialog(this, message,
                            "Success", JOptionPane.INFORMATION_MESSAGE);
                    refreshUsers();
                } else {
                    JOptionPane.showMessageDialog(this, "Failed to adjust reputation",
                            "Error", JOptionPane.ERROR_MESSAGE);
                }
            } catch (NumberFormatException e) {
                JOptionPane.showMessageDialog(this, "Please enter a valid number",
                        "Error", JOptionPane.ERROR_MESSAGE);
            } catch (Exception e) {
                JOptionPane.showMessageDialog(this,
                        "Error: " + e.getMessage(),
                        "Database Error", JOptionPane.ERROR_MESSAGE);
            }
        }
    }

    private void deleteUser() {
        int selectedRow = usersTable.getSelectedRow();
        if (selectedRow == -1) {
            JOptionPane.showMessageDialog(this, "Please select a user",
                    "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        int userId = (int) usersTableModel.getValueAt(selectedRow, 0);
        String username = (String) usersTableModel.getValueAt(selectedRow, 1);
        boolean isAdmin = "admin".equals(usersTableModel.getValueAt(selectedRow, 2));

        if (isAdmin) {
            JOptionPane.showMessageDialog(this, "Cannot delete admin accounts",
                    "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        int confirm = JOptionPane.showConfirmDialog(this,
                "Are you sure you want to delete user '" + username + "'?\n" +
                        "All their borrowing records will also be deleted.",
                "Confirm Deletion", JOptionPane.YES_NO_OPTION, JOptionPane.WARNING_MESSAGE);

        if (confirm == JOptionPane.YES_OPTION) {
            try {
                library.refreshConnection();
                boolean success = library.deleteUser(userId);
                if (success) {
                    JOptionPane.showMessageDialog(this,
                            "User deleted successfully!", "Success",
                            JOptionPane.INFORMATION_MESSAGE);
                    refreshUsers();
                } else {
                    JOptionPane.showMessageDialog(this, "Failed to delete user",
                            "Error", JOptionPane.ERROR_MESSAGE);
                }
            } catch (Exception e) {
                JOptionPane.showMessageDialog(this,
                        "Error: " + e.getMessage(),
                        "Database Error", JOptionPane.ERROR_MESSAGE);
            }
        }
    }

    private void viewUserProfile() {
        int selectedRow = usersTable.getSelectedRow();
        if (selectedRow == -1) {
            JOptionPane.showMessageDialog(this, "Please select a user",
                    "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        int userId = (int) usersTableModel.getValueAt(selectedRow, 0);
        String username = (String) usersTableModel.getValueAt(selectedRow, 1);
        String role = (String) usersTableModel.getValueAt(selectedRow, 2);

        if (!"student".equals(role)) {
            JOptionPane.showMessageDialog(this,
                    "Only student profiles can be viewed in detail",
                    "Info", JOptionPane.INFORMATION_MESSAGE);
            return;
        }

        try {
            library.refreshConnection();
            User selectedUser = library.getUserProfile(userId);
            if (selectedUser != null) {
                new UserProfileViewFrame(library, selectedUser).setVisible(true);
            }
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this,
                    "Error loading profile: " + e.getMessage(),
                    "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void changePassword(JPasswordField newPassField, JPasswordField confirmPassField) {
        String newPass = new String(newPassField.getPassword());
        String confirmPass = new String(confirmPassField.getPassword());

        if (newPass.isEmpty()) {
            JOptionPane.showMessageDialog(this,
                    "Password cannot be empty", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        if (!newPass.equals(confirmPass)) {
            JOptionPane.showMessageDialog(this,
                    "Passwords do not match", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        if (newPass.length() < 4) {
            JOptionPane.showMessageDialog(this,
                    "Password must be at least 4 characters long", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        try {
            library.refreshConnection();
            boolean success = library.changePassword(user.getId(), newPass);
            if (success) {
                JOptionPane.showMessageDialog(this,
                        "Password changed successfully!", "Success",
                        JOptionPane.INFORMATION_MESSAGE);
                newPassField.setText("");
                confirmPassField.setText("");
            } else {
                JOptionPane.showMessageDialog(this,
                        "Failed to change password", "Error", JOptionPane.ERROR_MESSAGE);
            }
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this,
                    "Error: " + e.getMessage(),
                    "Database Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void logout() {
        dispose();
        new LoginFrame().setVisible(true);
    }
}