package librarysystem;

import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.sql.*;

public class LoginFrame extends JFrame {
    private JTextField usernameField;
    private JPasswordField passwordField;
    private Library library;

    public LoginFrame() {
        library = new Library();
        initComponents();
    }

    private void initComponents() {
        setTitle("Library Management System - Login");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setSize(400, 300);
        setLocationRelativeTo(null);

        JPanel mainPanel = new JPanel(new BorderLayout());
        mainPanel.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));

        JLabel titleLabel = new JLabel("Library Management System", SwingConstants.CENTER);
        titleLabel.setFont(new Font("Arial", Font.BOLD, 18));
        mainPanel.add(titleLabel, BorderLayout.NORTH);

        JPanel formPanel = new JPanel(new GridBagLayout());
        formPanel.setBorder(BorderFactory.createTitledBorder("Login"));
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(10, 10, 10, 10);
        gbc.fill = GridBagConstraints.HORIZONTAL;

        gbc.gridx = 0;
        gbc.gridy = 0;
        formPanel.add(new JLabel("Username:"), gbc);

        gbc.gridx = 1;
        usernameField = new JTextField(15);
        formPanel.add(usernameField, gbc);

        gbc.gridx = 0;
        gbc.gridy = 1;
        formPanel.add(new JLabel("Password:"), gbc);

        gbc.gridx = 1;
        passwordField = new JPasswordField(15);
        formPanel.add(passwordField, gbc);

        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 10, 0));
        JButton loginButton = new JButton("Login");
        JButton registerButton = new JButton("Register");

        loginButton.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                login();
            }
        });

        registerButton.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                showRegisterDialog();
            }
        });

        buttonPanel.add(loginButton);
        buttonPanel.add(registerButton);

        gbc.gridx = 0;
        gbc.gridy = 2;
        gbc.gridwidth = 2;
        formPanel.add(buttonPanel, gbc);

        mainPanel.add(formPanel, BorderLayout.CENTER);
        add(mainPanel);
    }

    private void login() {
        String username = usernameField.getText().trim();
        String password = new String(passwordField.getPassword()).trim();

        if (username.isEmpty() || password.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Please enter username and password",
                    "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        User user = library.login(username, password);
        if (user != null) {
            if (user.isLocked()) {
                JOptionPane.showMessageDialog(this,
                        "Your account is locked. Please contact administrator.",
                        "Account Locked", JOptionPane.ERROR_MESSAGE);
                return;
            }

            dispose();
            if (user.getRole().equals("admin")) {
                new AdminDashboard(library, user).setVisible(true);
            } else {
                new StudentDashboard(library, user).setVisible(true);
            }
        } else {
            checkUserStatus(username, password);
        }
    }

    private void checkUserStatus(String username, String password) {
        try {
            Connection conn = DatabaseConnection.getConnection();
            String sql = "SELECT is_locked FROM users WHERE username = ? AND password = ?";
            PreparedStatement stmt = conn.prepareStatement(sql);
            stmt.setString(1, username);
            stmt.setString(2, password);
            ResultSet rs = stmt.executeQuery();

            if (rs.next()) {
                boolean isLocked = rs.getBoolean("is_locked");
                if (isLocked) {
                    JOptionPane.showMessageDialog(this,
                            "Your account is locked. Please contact administrator.",
                            "Account Locked", JOptionPane.ERROR_MESSAGE);
                } else {
                    JOptionPane.showMessageDialog(this, "Invalid credentials",
                            "Login Failed", JOptionPane.ERROR_MESSAGE);
                }
            } else {
                String checkUsernameSql = "SELECT username FROM users WHERE username = ?";
                PreparedStatement checkStmt = conn.prepareStatement(checkUsernameSql);
                checkStmt.setString(1, username);
                ResultSet rs2 = checkStmt.executeQuery();

                if (rs2.next()) {
                    JOptionPane.showMessageDialog(this, "Incorrect password",
                            "Login Failed", JOptionPane.ERROR_MESSAGE);
                } else {
                    JOptionPane.showMessageDialog(this, "Username does not exist",
                            "Login Failed", JOptionPane.ERROR_MESSAGE);
                }
                checkStmt.close();
            }

            stmt.close();
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(this,
                    "Error checking user status: " + e.getMessage(),
                    "Database Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void showRegisterDialog() {
        JTextField regUsername = new JTextField();
        JPasswordField regPassword = new JPasswordField();
        JPasswordField confirmPassword = new JPasswordField();

        JPanel panel = new JPanel(new GridLayout(0, 2, 10, 10));
        panel.add(new JLabel("Username:"));
        panel.add(regUsername);
        panel.add(new JLabel("Password:"));
        panel.add(regPassword);
        panel.add(new JLabel("Confirm Password:"));
        panel.add(confirmPassword);

        int result = JOptionPane.showConfirmDialog(this, panel, "Register New Student",
                JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);

        if (result == JOptionPane.OK_OPTION) {
            String username = regUsername.getText().trim();
            String password = new String(regPassword.getPassword()).trim();
            String confirm = new String(confirmPassword.getPassword()).trim();

            if (!password.equals(confirm)) {
                JOptionPane.showMessageDialog(this, "Passwords do not match",
                        "Error", JOptionPane.ERROR_MESSAGE);
                return;
            }

            if (username.isEmpty() || password.isEmpty()) {
                JOptionPane.showMessageDialog(this, "Please fill all fields",
                        "Error", JOptionPane.ERROR_MESSAGE);
                return;
            }

            if (username.length() < 3) {
                JOptionPane.showMessageDialog(this, "Username must be at least 3 characters long",
                        "Error", JOptionPane.ERROR_MESSAGE);
                return;
            }

            if (password.length() < 4) {
                JOptionPane.showMessageDialog(this, "Password must be at least 4 characters long",
                        "Error", JOptionPane.ERROR_MESSAGE);
                return;
            }

            boolean success = library.registerUser(username, password);
            if (success) {
                JOptionPane.showMessageDialog(this,
                        "Registration successful! Please login with your new account.",
                        "Success", JOptionPane.INFORMATION_MESSAGE);

                usernameField.setText(username);
                passwordField.setText("");
            } else {
                JOptionPane.showMessageDialog(this, "Username already exists",
                        "Error", JOptionPane.ERROR_MESSAGE);
            }
        }
    }
}